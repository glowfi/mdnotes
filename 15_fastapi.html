<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>15_fastapi - Markdown Notes</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="1_react_1_fundamentals.html"><strong aria-hidden="true">1.</strong> 1_react_1_fundamentals</a></li><li class="chapter-item expanded "><a href="2_react_2_advanced.html"><strong aria-hidden="true">2.</strong> 2_react_2_advanced</a></li><li class="chapter-item expanded "><a href="3_react_3_axios.html"><strong aria-hidden="true">3.</strong> 3_react_3_axios</a></li><li class="chapter-item expanded "><a href="4_react_4_router_dom.html"><strong aria-hidden="true">4.</strong> 4_react_4_router_dom</a></li><li class="chapter-item expanded "><a href="5_react_5_redux_tookit.html"><strong aria-hidden="true">5.</strong> 5_react_5_redux_tookit</a></li><li class="chapter-item expanded "><a href="6_node_1_fundamentals.html"><strong aria-hidden="true">6.</strong> 6_node_1_fundamentals</a></li><li class="chapter-item expanded "><a href="7_node_2_advanced.html"><strong aria-hidden="true">7.</strong> 7_node_2_advanced</a></li><li class="chapter-item expanded "><a href="8_node_3_orm.html"><strong aria-hidden="true">8.</strong> 8_node_3_orm</a></li><li class="chapter-item expanded "><a href="9_node_4_apollo_graphql_basics.html"><strong aria-hidden="true">9.</strong> 9_node_4_apollo_graphql_basics</a></li><li class="chapter-item expanded "><a href="10_node_5_typescript.html"><strong aria-hidden="true">10.</strong> 10_node_5_typescript</a></li><li class="chapter-item expanded "><a href="11_node_6_graphql_ts_orm.html"><strong aria-hidden="true">11.</strong> 11_node_6_graphql_ts_orm</a></li><li class="chapter-item expanded "><a href="12_sql.html"><strong aria-hidden="true">12.</strong> 12_sql</a></li><li class="chapter-item expanded "><a href="13_sql_alchemy.html"><strong aria-hidden="true">13.</strong> 13_sql_alchemy</a></li><li class="chapter-item expanded "><a href="14_redis.html"><strong aria-hidden="true">14.</strong> 14_redis</a></li><li class="chapter-item expanded "><a href="15_fastapi.html" class="active"><strong aria-hidden="true">15.</strong> 15_fastapi</a></li><li class="chapter-item expanded "><a href="16_react_hooks_compressed.html"><strong aria-hidden="true">16.</strong> 16_react_hooks_compressed</a></li><li class="chapter-item expanded "><a href="17_react_Typescript.html"><strong aria-hidden="true">17.</strong> 17_react_Typescript</a></li><li class="chapter-item expanded "><a href="18_next_JS_14.html"><strong aria-hidden="true">18.</strong> 18_next_JS_14</a></li><li class="chapter-item expanded "><a href="19_React+Node_JS_JWT.html"><strong aria-hidden="true">19.</strong> 19_React+Node_JS_JWT</a></li><li class="chapter-item expanded "><a href="20_Fastapi_JWT_Scratch_React.html"><strong aria-hidden="true">20.</strong> 20_Fastapi_JWT_Scratch_React</a></li><li class="chapter-item expanded "><a href="21_Mongodb.html"><strong aria-hidden="true">21.</strong> 21_Mongodb</a></li><li class="chapter-item expanded "><a href="22_TRPC.html"><strong aria-hidden="true">22.</strong> 22_TRPC</a></li><li class="chapter-item expanded "><a href="23_React_Query.html"><strong aria-hidden="true">23.</strong> 23_React_Query</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Markdown Notes</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="fastapi"><a class="header" href="#fastapi">FastAPI</a></h1>
<h3 id="install-dependencies"><a class="header" href="#install-dependencies">Install dependencies</a></h3>
<pre><code class="language-sh">pip install fastapi uvicorn sqlalchemy strawberry-graphql[debug-server] asyncio python-dotenv asyncpg
</code></pre>
<h2 id="a-simple-crud-app-using-sqlalchemy-coreasyncpgfastapi"><a class="header" href="#a-simple-crud-app-using-sqlalchemy-coreasyncpgfastapi">A simple crud app using sqlalchemy core,asyncpg,fastapi</a></h2>
<p>.env</p>
<pre><code>DB_URL=postgresql+asyncpg://postgres:@localhost/fastdb
</code></pre>
<blockquote>
<p>main.py</p>
</blockquote>
<pre><code class="language-py">import uvicorn
from fastapi import FastAPI
from sqlalchemy import delete, insert, select, update
from connectdb import engine
from tables import user_table, post_table
from schema import Post, PostBody, updateBody
from connectdb import engine


app = FastAPI()


@app.get("/post", response_model=list[Post])
async def get_all_posts():
    async with engine.connect() as conn:
        st = select(post_table)
        res = await conn.execute(st)
        data = res.scalars()
        return data


@app.get("/post/{id}", response_model=Post)
async def get_post_by_id(id: int):
    async with engine.connect() as conn:
        st = select(post_table).filter_by(id=id)
        res = await conn.execute(st)
        data = res.scalars()
        return data


@app.post("/post")
async def create_post(bd: PostBody):
    async with engine.connect() as conn:
        st = insert(post_table).values(
            title=bd.title, description=bd.description, author_id=bd.aid
        )
        await conn.execute(st)
        await conn.commit()
        return bd


@app.put("/post/{id}")
async def update_post(id: int, bd: updateBody):
    async with engine.connect() as conn:
        st = (
            update(post_table)
            .where(post_table.c.id == id)
            .values(title=bd.title, description=bd.description)
        )
        await conn.execute(st)
        await conn.commit()
        return bd


@app.delete("/post/{id}")
async def delete_post(id: int):
    async with engine.connect() as conn:
        st = delete(post_table).where(post_table.c.id == id)
        await conn.execute(st)
        await conn.commit()
    return {"msg": "Deleted!"}


@app.get("/")
async def hello():
    return {"msg": "hello_world"}


if __name__ == "__main__":
    uvicorn.run("main:app", reload=True, log_level="info", workers=4, port=5000)
</code></pre>
<blockquote>
<p>connectdb.py</p>
</blockquote>
<pre><code class="language-py">from sqlalchemy.ext.asyncio import create_async_engine
import asyncio
from tables import meta_obj
from dotenv import load_dotenv
import os


# Load ENV variables
load_dotenv()

# Engine
engine = create_async_engine(os.getenv("DB_URL"), echo=True)


# Create DB
async def main():
    async with engine.begin() as conn:
        await conn.run_sync(meta_obj.create_all)
        print("Connected to DB...")
    await engine.dispose()


asyncio.run(main())
</code></pre>
<blockquote>
<p>schema.py</p>
</blockquote>
<pre><code class="language-py">from pydantic import BaseModel
from datetime import datetime


class Post(BaseModel):
    id: int
    title: str
    description: str
    createdAt: datetime
    updatedAt: datetime
    author_id: int

    class Config:
        orm_mode = True


class PostBody(BaseModel):
    aid: int
    title: str
    description: str


class updateBody(BaseModel):
    title: str
    description: str
</code></pre>
<blockquote>
<p>tables.py</p>
</blockquote>
<pre><code class="language-py">from sqlalchemy import (
    MetaData,
    Column,
    Table,
    Integer,
    String,
    Text,
    ForeignKey,
    DateTime,
)
from datetime import datetime

meta_obj = MetaData()


# Users table
"""
Users Table
    - id (pk)
    - email (str)
    - password (str)
"""

args = [
    Column("id", Integer, primary_key=True),
    Column("email", String(50), unique=True, nullable=False),
    Column("password", String(50), nullable=False),
]
user_table = Table("users", meta_obj, *args)

# Post table
"""
Posts Table
    - id (pk)
    - title (str)
    - description (str)
    - createdAt(datetime)
    - updatedAt(datetime)
    - author_id (int,fk refrencing the id in user table)
"""

args = [
    Column("id", Integer, primary_key=True),
    Column("title", Text, unique=True, nullable=False),
    Column("description", Text, nullable=False),
    Column("createdAt", DateTime, default=datetime.utcnow),
    Column("updatedAt", DateTime, onupdate=datetime.utcnow),
    Column("author_id", Integer, ForeignKey("users.id")),
]
post_table = Table("posts", meta_obj, *args)
</code></pre>
<h2 id="a-simple-crud-app-using-sqlalchemy-ormasyncpgfastapi"><a class="header" href="#a-simple-crud-app-using-sqlalchemy-ormasyncpgfastapi">A simple crud app using sqlalchemy orm,asyncpg,fastapi</a></h2>
<p>.env</p>
<pre><code>DB_URL=postgresql+asyncpg://postgres:@localhost/fastdb
</code></pre>
<blockquote>
<p>main.py</p>
</blockquote>
<pre><code class="language-py">import uvicorn
from fastapi import FastAPI
from sqlalchemy import delete, insert, select, update
from connectdb import engine
from connectdb import sess
from schema import Post, PostBody, updateBody
from connectdb import engine
from crud import get_all, create_, update_, delete_


app = FastAPI()


@app.get("/post", response_model=list[Post])
async def get_all_posts():
    data = await get_all(sess)
    return data


@app.get("/post/{id}", response_model=Post)
async def get_post_by_id(id: int):
    pass


@app.post("/post", response_model=Post)
async def create_post(bd: PostBody):
    data = await create_(sess, bd)
    return data


@app.put("/post/{id}")
async def update_post(id: int, bd: updateBody):
    data = await update_(sess, bd, id)
    return data


@app.delete("/post/{id}")
async def delete_post(id: int):
    data = await delete_(sess, id)
    return data


@app.get("/")
async def hello():
    return {"msg": "hello_world"}


if __name__ == "__main__":
    uvicorn.run("main:app", reload=True, log_level="info", workers=4, port=5000)
</code></pre>
<blockquote>
<p>connectdb.py</p>
</blockquote>
<pre><code class="language-py">from sqlalchemy import text, create_engine
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker
import asyncio
from tables import Base
from dotenv import load_dotenv
import os


# Load ENV variables
load_dotenv()

# Engine
engine = create_async_engine(os.getenv("DB_URL"), echo=True)
sess = async_sessionmaker(bind=engine, expire_on_commit=False)


# Create DB
async def main():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
        print("Connected to DB...")
    await engine.dispose()


asyncio.run(main())
</code></pre>
<blockquote>
<p>tables.py</p>
</blockquote>
<pre><code class="language-py">from sqlalchemy import (
    Integer,
    String,
    Text,
    ForeignKey,
    DateTime,
)
from datetime import datetime
from sqlalchemy.orm import Mapped, mapped_column, DeclarativeBase, relationship


class Base(DeclarativeBase):
    pass


# Users table
"""
Users Table
    - id (pk)
    - email (str)
    - password (str)
"""


class User(Base):
    __tablename__ = "users"
    id: Mapped[int] = mapped_column("id", Integer, primary_key=True)
    email: Mapped[str] = mapped_column("email", String(50), nullable=False)
    password: Mapped[str] = mapped_column("password", String(50), nullable=False)
    posts: Mapped[list["Post"]] = relationship(
        "Post", back_populates="user", cascade="delete,all"
    )


# Post table
"""
Posts Table
    - id (pk)
    - title (str)
    - description (str)
    - createdAt(datetime)
    - updatedAt(datetime)
    - author_id (int,fk refrencing the id in user table)
"""


class Post(Base):
    __tablename__ = "posts"
    id: Mapped[int] = mapped_column("id", Integer, primary_key=True)
    title: Mapped[str] = mapped_column("title", Text, nullable=False)
    description: Mapped[str] = mapped_column("description", Text, nullable=False)
    createdAt: Mapped[DateTime] = mapped_column(
        "createdAt", DateTime, default=datetime.utcnow
    )
    updatedAt: Mapped[DateTime] = mapped_column(
        "updatedAt", DateTime, onupdate=datetime.utcnow, nullable=True
    )
    user_id: Mapped[int] = mapped_column(
        "user_id", Integer, ForeignKey("users.id"), nullable=False
    )
    user: Mapped[User] = relationship(
        "User", back_populates="posts", cascade="delete,all"
    )
</code></pre>
<blockquote>
<p>schema.py</p>
</blockquote>
<pre><code class="language-py">from pydantic import BaseModel
from datetime import datetime


class Post(BaseModel):
    id: int
    title: str
    description: str
    createdAt: datetime
    user_id: int

    class Config:
        orm_mode = True


class PostBody(BaseModel):
    aid: int
    title: str
    description: str


class updateBody(BaseModel):
    title: str
    description: str
</code></pre>
<blockquote>
<p>crud.py</p>
</blockquote>
<pre><code class="language-py">from sqlalchemy import delete, update
from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker
from sqlalchemy.sql import select
from tables import User, Post


async def get_all(sessmaker: async_sessionmaker[AsyncSession]):
    async with sessmaker() as session:
        st = select(Post)
        res = await session.execute(st)
        return res


async def get_by_id(sessmaker: async_sessionmaker[AsyncSession]):
    async with sessmaker() as session:
        pass


async def create_(sessmaker: async_sessionmaker[AsyncSession], data):
    async with sessmaker() as session:
        newpost = Post(title=data.title, description=data.description)
        newpost.user_id = data.aid

        session.add(newpost)
        await session.commit()
        print(newpost)
        return newpost


async def update_(sessmaker: async_sessionmaker[AsyncSession], data, id):
    async with sessmaker() as session:
        st = select(Post).where(Post.id == id)
        res = await session.execute(st)
        final_data = res.scalar()
        if final_data:
            if data.title:
                final_data.title = data.title
            if data.description:
                final_data.description = data.description
            await session.commit()
        return final_data


async def delete_(sessmaker: async_sessionmaker[AsyncSession], id):
    async with sessmaker() as session:
        print(id)
        st = delete(Post).where(Post.id == id)
        res = await session.execute(st)
        await session.commit()
        return res
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="14_redis.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="16_react_hooks_compressed.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="14_redis.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="16_react_hooks_compressed.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
